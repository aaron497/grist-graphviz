<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Referral Graph</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <script src="./json.js"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    #graph {
      width: 100%;
      height: calc(100vh - 60px);
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: auto;
    }

    #graph svg {
      max-width: 100%;
      height: auto;
    }

    #error {
      color: #d32f2f;
      padding: 10px;
      display: none;
    }
  </style>
</head>

<body>
  <div id="error"></div>
  <div id="graph"></div>

  <script>
    const viz = new Viz();
    const USE_TEST_DATA = false; // Toggle for local testing vs Grist
    let panZoomInstance;

    function showError(msg) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = msg;
      errorDiv.style.display = 'block';
    }

    function buildDotGraph(records) {
      if (!records || records.length === 0) {
        return 'digraph G { "No data" [shape=box] }';
      }

      let dot = 'digraph G {\n';
      dot += '  rankdir=LR;\n';
      dot += '  ranksep=1.5;\n';
      dot += '  nodesep=0.5;\n';
      dot += '  node [shape=box, style="rounded,filled", fillcolor="#e3f2fd", fontsize=12];\n';
      dot += '  edge [color="#1976d2", penwidth=2, arrowsize=0.8];\n\n';

      // Track which nodes have connections
      const connectedNodes = new Set();
      const nodeMap = new Map();

      // Build node map
      records.forEach(record => {
        const id = String(record.id);
        const label = record.Name || `Lead ${id}`;
        nodeMap.set(id, label);
      });

      // First pass: identify all connected nodes
      records.forEach(record => {
        const fromId = String(record.id);
        const referrers = record['Referred Me'];

        if (referrers && Array.isArray(referrers) && referrers.length > 0) {
          referrers.forEach(referrerId => {
            const refIdStr = String(referrerId);
            if (nodeMap.has(refIdStr)) {
              connectedNodes.add(fromId);
              connectedNodes.add(refIdStr);
            }
          });
        }
      });

      // Only add connected nodes
      connectedNodes.forEach(id => {
        const label = nodeMap.get(id);
        dot += `  "${id}" [label="${label}"];\n`;
      });

      dot += '\n  // Edges\n';

      // Create edges
      let edgeCount = 0;
      records.forEach(record => {
        const fromId = String(record.id);
        const referrers = record['Referred Me'];

        if (referrers && Array.isArray(referrers)) {
          referrers.forEach(referrerId => {
            const refIdStr = String(referrerId);
            if (nodeMap.has(refIdStr)) {
              dot += `  "${refIdStr}" -> "${fromId}";\n`;
              edgeCount++;
            }
          });
        }
      });

      console.log(`Connected nodes: ${connectedNodes.size}, Created ${edgeCount} edges`);

      dot += '}';
      return dot;
    }


    function renderGraph(records) {
      try {
        const dotString = buildDotGraph(records);
        console.log('DOT String:', dotString);

        viz.renderSVGElement(dotString)
          .then(svg => {
            const graphDiv = document.getElementById('graph');
            graphDiv.innerHTML = '';
            graphDiv.appendChild(svg);

            // Add zoom/pan
            if (panZoomInstance) {
              panZoomInstance.destroy();
            }
            panZoomInstance = svgPanZoom(svg, {
              zoomEnabled: true,
              controlIconsEnabled: true,
              fit: true,
              center: true,
              minZoom: 0.1,
              maxZoom: 10
            });
          })
          .catch(err => showError('Render error: ' + err.message));
      } catch (error) {
        showError('Error: ' + error.message);
        console.error(error);
      }
    }

    async function loadData() {
      if (USE_TEST_DATA) {
        console.log('Using test data:', records);
        renderGraph(records);
      } else {
        try {
          await grist.ready();

          await grist.setOptions({
            allowSelectBy: true,
            columns: ['Name', 'Referred_Me'],
            requiredAccess: 'read table'
          });

          grist.onRecords(function (records) {
            console.log('Received records:', records);
            renderGraph(records);

          });
        } catch (error) {
          showError('Error connecting to Grist: ' + error.message);
          console.error(error);
        }
      }
    }

    loadData();
  </script>
</body>

</html>